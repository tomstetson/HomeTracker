name: Security Scan

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '30 0 * * 1'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Backend Dependencies
        run: cd backend && npm ci

      - name: Install Frontend Dependencies
        run: cd frontend && npm ci

      - name: Audit Backend Dependencies
        run: cd backend && npm audit --audit-level=high

      - name: Audit Frontend Dependencies
        run: cd frontend && npm audit --audit-level=high

  osv-scanner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OSV Scanner
        uses: google/osv-scanner-action@v1
        continue-on-error: true
        with:
          scan-args: |-
            --lockfile=frontend/package-lock.json
            --lockfile=backend/package-lock.json
            --format=table

  semgrep:
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: semgrep scan --config auto --config p/security-audit --config p/nodejs --config p/typescript --config p/react --error --json > semgrep-results.json || true

      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

      - name: Check Semgrep Findings
        run: |
          if [ -s semgrep-results.json ]; then
            echo "Semgrep findings:"
            cat semgrep-results.json | jq '.results | length' 
            findings=$(cat semgrep-results.json | jq '.results | length')
            if [ "$findings" -gt 0 ]; then
              echo "::warning::Semgrep found $findings potential security issues"
              cat semgrep-results.json | jq '.results[] | {path: .path, line: .start.line, message: .extra.message, severity: .extra.severity}'
            fi
          fi

  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Repo)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  gitleaks-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
